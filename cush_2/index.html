<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/assy.css">
    <script src="/js/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="title_sect">
            <span class="title">Ov1k CUSH Process</span>
            <span class="clock"></span>
            <div class="logo">
                <button class = "power" onclick = "window.close()">
                    <img src = "/img/power.svg" width = "25" height = "25">
                </button>
            </div>
        </div>

        <div class="content_sect">
            <div class="lh_frame">
                <span class="frame_title">PRODUCT IMAGE LH</span>

                <img src="/img/cush_lh.jpg" id = "img_lh">

                <div class="data_area">
                    <div class="part">  
                        <span class="frame_title">CONCLUSION</span>
                        <div class="conclusion">
                            <span id="conclusion_lh"></span>
                        </div>
                    </div>

                    <div class="point">
                        <div class="row">
                            <div class="label">
                                <span>살</span>
                            </div>

                            <div class="value">
                                <span id="data1_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>헤드 1</span>
                            </div>

                            <div class="value">
                                <span id="data2_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>헤드 2</span>
                            </div>

                            <div class="value">
                                <span id="data3_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>너트</span>
                            </div>

                            <div class="value">
                                <span id="data4_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 1</span>
                            </div>

                            <div class="value">
                                <span id="tq1_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 2</span>
                            </div>

                            <div class="value">
                                <span id="tq2_lh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 3</span>
                            </div>

                            <div class="value">
                                <span id="tq3_lh"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rh_frame">
                <span class="frame_title">PRODUCT IMAGE RH</span>

                <img src="/img/cush_rh.jpg" id = "img_rh">

                <div class="data_area">
                    <div class="part">
                        <span class="frame_title">CONCLUSION</span>
                        <div class="conclusion">
                            <span id="conclusion_rh"></span>
                        </div>
                    </div>

                    <div class="point">
                        <div class="row">
                            <div class="label">
                                <span>살</span>
                            </div>

                            <div class="value">
                                <span id="data1_rh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>헤드</span>
                            </div>

                            <div class="value">
                                <span id="data2_rh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>너트</span>
                            </div>

                            <div class="value">
                                <span id="data3_rh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 1</span>
                            </div>

                            <div class="value">
                                <span id="tq1_rh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 2</span>
                            </div>

                            <div class="value">
                                <span id="tq2_rh"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="label">
                                <span>토크 3</span>
                            </div>

                            <div class="value">
                                <span id="tq3_rh"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class = "rank_frame">
                <span class = "frame_title">RANK IMAGE</span>

                <div id = "img_rank"></div>

                <div class = "rank_row">
                    <div class = "label">
                        <span>등급</span>
                    </div>

                    <div class = "value">
                        <span id = "rank"></span>
                    </div>
                </div>

                <div class = "rank_row">
                    <div class = "label">
                        <span>판독률</span>
                    </div>

                    <div class = "value">
                        <span id = "rank_per"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class = "list_sect">
            <span class = "frame_title">Recent result</span>

            <div class = "table_header">
                <div class = "dir">
                    <span>Dir</span>
                </div>

                <div class = "count">
                    <span>Count</span>
                </div>

                <div class = "data1">
                    <span>살</span>
                </div>

                <div class = "data2">
                    <span>헤드 1</span>
                </div>

                <div class = "data3">
                    <span>헤드 2</span>
                </div>

                <div class = "data4">
                    <span>너트</span>
                </div>

                <div class = "data5">
                    <span>토크 1</span>
                </div>

                <div class = "data6">
                    <span>토크 2</span>
                </div>

                <div class = "data7">
                    <span>토크 3</span>
                </div>

                <div class = "data8">
                    <span>전체</span>
                </div>

                <div class = "data9">
                    <span>등급</span>
                </div>
            </div>

            <div class = "table_bg">
                <table class = "list_table">
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            updateClock();
            updateData();
            updateList();
        });

        function updateClock() {
            const now = new Date();
            const formats = { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false };
            const datetime = now.toLocaleString("ko-KR", formats);

            $(".clock").text(datetime);
        }

        function updateData() {
            $.ajax({
                url: "/api/get_data.php",
                type: "POST",
                success: function (result) {
                    var dataAll = JSON.parse(result);
                    var data = dataAll[0];
                    var torqueStr = dataAll[1];
                    var regex = /(\d+\.\d{1})/g; // 소수점 한 자리까지의 실수를 찾는 정규 표현식
                    var matches = torqueStr.match(regex);
                    var rank = dataAll[2];
                    var rankPer = dataAll[3];

                    var torqueArr = Array();
                    if (matches && matches.length === 3) {
                        torqueArr[0] = parseFloat(matches[0]);
                        torqueArr[1] = parseFloat(matches[1]);
                        torqueArr[2] = parseFloat(matches[2]);
                    }

                    var dir = data[0];

                    if(dir == 1){
                        for(i = 1; i < data.length - 1; i++){
                            let idLH = "data" + i + "_lh";

                            if(data[i] == 1){
                                $("#" + idLH).text("OK");
                                $("#" + idLH).parent().css("background-color", "green");
                            }else if(data[i] == 2){
                                $("#" + idLH).text("NG");
                                $("#" + idLH).parent().css("background-color", "red");
                            }else{
                                $("#" + idLH).text("");
                                $("#" + idLH).parent().css("background-color", "white");
                            }
                        }

                        for(i = 1; i <= 3; i++){
                            let idRH = "data" + i + "_rh";

                            $("#" + idRH).text("");
                            $("#" + idRH).parent().css("background-color", "white");
                        }

                        var conclusion = data[data.length - 1];
                        if(conclusion == 1){
                            $("#conclusion_lh").text("OK");
                            $("#conclusion_lh").parent().css("background-color", "green");
                        }else if(conclusion == 2){
                            $("#conclusion_lh").text("NG");
                            $("#conclusion_lh").parent().css("background-color", "red");
                        }else{
                            $("#conclusion_lh").text("OK");
                            $("#conclusion_lh").parent().css("background-color", "white");
                        }

                        $("#conclusion_rh").text("");
                        $("#conclusion_rh").parent().css("background-color", "white");

                        if(torqueArr && torqueArr.length === 3){
                            $("#tq1_lh").text(torqueArr[0]);
                            $("#tq2_lh").text(torqueArr[1]);
                            $("#tq3_lh").text(torqueArr[2]);
                        }

                        $("#tq1_rh").text("");
                        $("#tq2_rh").text("");
                        $("#tq3_rh").text("");
                    }else if(dir == 2){
                        for(i = 1; i < data.length - 1; i++){
                            let idRH = "data" + i + "_rh";

                            if(data[i] == 1){
                                $("#" + idRH).text("OK");
                                $("#" + idRH).parent().css("background-color", "green");
                            }else if(data[i] == 2){
                                $("#" + idRH).text("NG");
                                $("#" + idRH).parent().css("background-color", "red");
                            }else{
                                $("#" + idRH).text("");
                                $("#" + idRH).parent().css("background-color", "white");
                            }
                        }

                        for(i = 1; i <= 4; i++){
                            let idLH = "data" + i + "_lh";

                            $("#" + idLH).text("");
                            $("#" + idLH).parent().css("background-color", "white");
                        }

                        var conclusion = data[data.length - 1];
                        if(conclusion == 1){
                            $("#conclusion_rh").text("OK");
                            $("#conclusion_rh").parent().css("background-color", "green");
                        }else if(conclusion == 2){
                            $("#conclusion_rh").text("NG");
                            $("#conclusion_rh").parent().css("background-color", "red");
                        }else{
                            $("#conclusion_rh").text("");
                            $("#conclusion_rh").parent().css("background-color", "white");
                        }

                        $("#conclusion_lh").text("");
                        $("#conclusion_lh").parent().css("background-color", "white");

                        $("#tq1_lh").text("");
                        $("#tq2_lh").text("");
                        $("#tq3_lh").text("");

                        if(torqueArr && torqueArr.length === 3){
                            $("#tq1_rh").text(torqueArr[0]);
                            $("#tq2_rh").text(torqueArr[1]);
                            $("#tq3_rh").text(torqueArr[2]);
                        }
                    }

                    $("#img_rank").css("background-image", `url(http://localhost:8080/1.jpg?t=${new Date().getTime()})`);
                    $("#img_rank").css("background-size", "cover");
                    $("#rank").text(rank);
                    if(rankPer != ""){
                        $("#rank_per").text(rankPer + "%");
                    }else{
                        $("#rank_per").text("");
                    }
                }
            });
        }

        function updateList(){
            $.ajax({
                url: "/api/get_recent_result.php",
                type: "POST",
                success: function(result){
                    var data = JSON.parse(result);

                    const listTable = $(".list_table");
                    listTable.empty();

                    for(i = 0; i < data.length; i++){
                        listTable.append("<tr><td>" + data[i]['dir'] + "</td><td>" + data[i]['count'] + "</td><td>" + data[i]['data1'] + "</td><td>" + data[i]['data2'] + "</td><td>" + data[i]['data3'] + "</td><td>" + data[i]['data4'] + "</td><td>" + data[i]['data5'] + "</td><td>" + data[i]['data6'] + "</td><td>" + data[i]['data7'] + "</td><td>" + data[i]['data8'] + "</td><td>" + data[i]['data9'] + "</td></tr>");
                    }
                }
            });
        }

        setInterval(updateClock, 1000);
        setInterval(updateData, 1000);
        setInterval(updateList, 1000);
    </script>
</body>

</html>